<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改运输车辆信息</title>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="添加运输车辆">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link href="../image/ioc/favicon.ico" rel="icon" type="image/x-ico">
    <link rel="stylesheet" href="../js/layuiadmin/style/login.css" media="all">
    <link rel="stylesheet" type="text/css" href="../js/layuiadmin/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="./css/style.css">
    <script src="../js/layuiadmin/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/jquery-1.12.4.js"></script>
    <link rel="stylesheet" href="./util/lgallery/css/lgallery.min.css">
    <link rel="stylesheet" href="./util/lgallery/css/demo.min.css">
    <style>
        .layui-form-pane .layui-form-label {
            width: 116px;
        }

        .layui-input, .layui-textarea {
            width: 97%;
        }
    </style>
</head>
<body>
<div style="padding: 15px;">
    <form class="layui-form layui-form-pane">

        <div class="layui-form-item ">
            <div class="layui-inline">
                <label class="layui-form-label">驾驶员姓名</label>
                <div class="layui-input-inline">
                    <input id="driver_name" type="text" name="driver_name" required lay-verify="required"
                           autocomplete="off"
                           class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">手机号</label>
                <div class="layui-input-inline">
                    <input id="driver_mobile" type="text" name="driver_mobile" required lay-verify="required|phone"
                           autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item ">
            <div class="layui-inline">
                <label class="layui-form-label">车型</label>
                <div class="layui-input-inline">
                    <input id="car_type" type="text" name="car_type" required lay-verify="required" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">车牌号</label>
                <div class="layui-input-inline">
                    <input id="car_license" type="text" name="car_license" required lay-verify="required"
                           autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">行驶证一名称</label>
                <div class="layui-input-inline">
                    <input id="xsz1" type="text" name="xsz1" required lay-verify="required" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item islook">
            <div class="layui-inline">
                <label class="layui-form-label">行驶证一照片</label>
                <div class="layui-input-inline">
                    <button class="takePhoto layui-btn" photo-type="y1" type="button">上传图片</button>
                </div>
            </div>
        </div>
        <div id="ys_1" class="layui-form-item hide">
            <fieldset class="layui-elem-field">
                <legend>行驶证一照片</legend>
                <div class="layui-field-box">
                    <div class="TemplateParent" data-lgparent data-lgtitle="1,2,3,4,5"
                         data-lglabel="Picture 1,Picture 2,Picture 3,Picture 4,Picture 5"
                         data-lgdescription="Description 1, Description 2,Description 3,Description 4,Description 5">

                    </div>
                </div>
            </fieldset>
        </div>
        <div class="layui-form-item ">
            <div class="layui-inline">
                <label class="layui-form-label">行驶证二名称</label>
                <div class="layui-input-inline">
                    <input id="xsz2" type="text" name="xsz2" required lay-verify="required" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item islook">
            <div class="layui-inline">
                <label class="layui-form-label">行驶证二照片</label>
                <div class="layui-input-inline">
                    <button class="takePhoto layui-btn" photo-type="y2" type="button">上传图片</button>
                </div>
            </div>
        </div>
        <div id="ys_2" class="layui-form-item hide">
            <fieldset class="layui-elem-field">
                <legend>行驶证二照片</legend>
                <div class="layui-field-box">
                    <div class="TemplateParent" data-lgparent data-lgtitle="1,2,3,4,5"
                         data-lglabel="Picture 1,Picture 2,Picture 3,Picture 4,Picture 5"
                         data-lgdescription="Description 1, Description 2,Description 3,Description 4,Description 5">

                    </div>
                </div>
            </fieldset>
        </div>
        <div class="layui-form-item ">
            <div class="layui-inline">
                <label class="layui-form-label">驾驶证号码</label>
                <div class="layui-input-inline">
                    <input id="jsz" type="text" name="jsz" required lay-verify="required" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item islook">
            <div class="layui-inline">
                <label class="layui-form-label">驾驶证照片</label>
                <div class="layui-input-inline">
                    <button class="takePhoto layui-btn" photo-type="y3" type="button">上传图片</button>
                </div>
            </div>
        </div>
        <div id="ys_3" class="layui-form-item hide">
            <fieldset class="layui-elem-field">
                <legend>驾驶证照片</legend>
                <div class="layui-field-box">
                    <div class="TemplateParent" data-lgparent data-lgtitle="1,2,3,4,5"
                         data-lglabel="Picture 1,Picture 2,Picture 3,Picture 4,Picture 5"
                         data-lgdescription="Description 1, Description 2,Description 3,Description 4,Description 5">

                    </div>
                </div>
            </fieldset>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">身份证号码</label>
                <div class="layui-input-inline">
                    <input id="sfz" type="text" name="sfz" required lay-verify="required" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item islook">
            <div class="layui-inline">
                <label class="layui-form-label">身份证照片</label>
                <div class="layui-input-inline">
                    <button class="takePhoto layui-btn" photo-type="y4" type="button">上传图片</button>
                </div>
            </div>
        </div>
        <div id="ys_4" class="layui-form-item hide">
            <fieldset class="layui-elem-field">
                <legend>身份证照片</legend>
                <div class="layui-field-box">
                    <div class="TemplateParent" data-lgparent data-lgtitle="1,2,3,4,5"
                         data-lglabel="Picture 1,Picture 2,Picture 3,Picture 4,Picture 5"
                         data-lgdescription="Description 1, Description 2,Description 3,Description 4,Description 5">

                    </div>
                </div>
            </fieldset>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">保险单号</label>
                <div class="layui-input-inline">
                    <input id="bxd" type="text" name="bxd" required lay-verify="required" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item islook">
            <div class="layui-inline">
                <label class="layui-form-label">保险单照片</label>
                <div class="layui-input-inline">
                    <button class="takePhoto layui-btn" photo-type="y5" type="button">上传图片</button>
                </div>
            </div>
        </div>
        <div id="ys_5" class="layui-form-item hide">
            <fieldset class="layui-elem-field">
                <legend>保险单照片</legend>
                <div class="layui-field-box">
                    <div class="TemplateParent" data-lgparent data-lgtitle="1,2,3,4,5"
                         data-lglabel="Picture 1,Picture 2,Picture 3,Picture 4,Picture 5"
                         data-lgdescription="Description 1, Description 2,Description 3,Description 4,Description 5">

                    </div>
                </div>
            </fieldset>
        </div>
        <!--   style="display: none;"   -->


        <div class="layui-form-item">
            <div class="layui-input-block">
                <button id="b_tj" class="layui-btn" lay-submit lay-filter="demo1">立即提交</button>
                <button  id="reset"  type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
        <input type="hidden" id="t_id" name="id"/>
        <input style="display: none" id="camera" type="file" name="vinnop" multiple="multiple" accept="image/*"
               capture="camera">
    </form>
</div>
</body>
<script type="text/javascript" src="../js/jquery-1.8.3.min.js"></script>
<script src="../js/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="../layer_mobile/layer.js"></script>
<script type="text/javascript" src="../js/jquery.md5.js"></script>
<script type="text/javascript" src="../js/jquery-geturlcode.js"></script>
<script type="text/javascript" src="../js/jquery.cookie.js"></script>
<script src="../js/common/api.js"></script>
<script src="../js/common/localjs.js"></script>
<script src="./util/lgallery/js/lgallery.min.js"></script>
<script type="text/javascript" src="../js/mui.min.js"></script>
<script>
    var photo_xsz1 = [];//行驶证一照片数组
    var photo_xsz2 = [];//行驶证二照片数组
    var photo_jsz = [];//驾驶证照片数组
    var photo_sfz = [];//身份证照片数组
    var photo_bxd = [];//保险单照片数组
    var id;//id


    //获得车辆信息
    function getCarInfo(id) {
        ajaxSubmit({id: id}, Api.YS_Car_Manage.Byid, "GET", function (res) {
            console.log("根据id获得的信息为-----------", res);
            var aa = res.data;


            //文本赋值
            $("#t_id").val(aa.id);
            $("#driver_name").val(aa.driver_name);
            $("#driver_mobile").val(aa.driver_mobile);
            $("#car_type").val(aa.car_type);
            $("#car_license").val(aa.car_license);
            $("#xsz1").val(aa.xszOne.name);
            $("#xsz2").val(aa.xszTwo.name);
            $("#jsz").val(aa.jsz.name);
            $("#sfz").val(aa.sfz.name);
            $("#bxd").val(aa.bxd.name);


            //图片赋值
            $.each(aa.xszOne.images, function (idx, obj) {
                $("#ys_1").show();
                $("#ys_1").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                $("#ys_1").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px; "> <img src="' + obj + '"/> <span>行驶证一照片</span> </div>');
                var suffix = obj.substr(obj.lastIndexOf("images/") + 7);
                //  console.log(suffix);
                photo_xsz1.push(suffix);
                // initLG();
            })
            //图片赋值
            $.each(aa.xszTwo.images, function (idx, obj) {
                $("#ys_2").show();
                $("#ys_2").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                $("#ys_2").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px; "> <img src="' + obj + '"/> <span>行驶证二照片</span> </div>');
                var suffix = obj.substr(obj.lastIndexOf("images/") + 7);
                //   console.log(suffix);
                photo_xsz2.push(suffix);
                // initLG();
            })

            $.each(aa.jsz.images, function (idx, obj) {
                $("#ys_3").show();
                $("#ys_3").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                $("#ys_3").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px; "> <img src="' + obj + '"/> <span>驾驶证照片</span> </div>');
                var suffix = obj.substr(obj.lastIndexOf("images/") + 7);
                //   console.log(suffix);
                photo_jsz.push(suffix);
                // initLG();
            })

            $.each(aa.sfz.images, function (idx, obj) {
                $("#ys_4").show();
                $("#ys_4").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                $("#ys_4").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px; "> <img src="' + obj + '"/> <span>身份证照片</span> </div>');
                var suffix = obj.substr(obj.lastIndexOf("images/") + 7);
                //  console.log(suffix);
                photo_sfz.push(suffix);
                // initLG();
            })
            $.each(aa.bxd.images, function (idx, obj) {
                $("#ys_5").show();
                $("#ys_5").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                $("#ys_5").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px; "> <img src="' + obj + '"/> <span>保险单照片</span> </div>');
                var suffix = obj.substr(obj.lastIndexOf("images/") + 7);
                // console.log(suffix);
                photo_bxd.push(suffix);
                // initLG();
            })

            initLG();
        })
    }


    //Demo
    layui.use(['jquery', 'form', 'layer'], function () {
        var form = layui.form,
            $ = layui.$,
            layer = layui.layer;

        var type = GetQueryString("type");


        id = GetQueryString("id");


        if (type == 0) {
            $(".islook").hide();
            $("#b_tj").attr("lay-filter", "back");
            $("#b_tj").html("返回");

            $("#reset").hide();

            $("#driver_name").attr("disabled", true);
            $("#driver_mobile").attr("disabled", true);
            $("#car_type").attr("disabled", true);
            $("#car_license").attr("disabled", true);
            $("#xsz1").attr("disabled", true);
            $("#xsz2").attr("disabled", true);
            $("#jsz").attr("disabled", true);
            $("#sfz").attr("disabled", true);
            $("#bxd").attr("disabled", true);
            form.render();
        }


        getCarInfo(id);


        $("#camera").on("change", function () {
            var that = $(this);
            var type = that.attr("photo-type");
            console.log("拍照的类型------", type);
            var b64;

//        $(this).prev().css("opacity", "1");
            var filePath = $(this).val(); //读取图片路径
            // alert(filePath);
            var fr = new FileReader(); //创建new FileReader()对象
            imgObj = this.files[0]; //获取图片
            //alert(imgObj);
            fr.readAsDataURL(imgObj); //将图片读取为DataURL
            //var obj = $("#pic"); //

            if (filePath.indexOf("jpg") != -1 || filePath.indexOf("JPG") != -1 || filePath.indexOf("PNG") != -1 || filePath.indexOf("png") != -1) {
                var arr = filePath.split('\\');
                var fileName = arr[arr.length - 1];
                fr.onload = function () {
                    //图片base64 编码字符
                    b64 = this.result;
                    console.log("拍照的类型------", type);
                    if (type == "y1") {
                        ImageajaxSubmit(b64, Api.YS_Car_Manage.Upload_image, "POST", function (res) {
                            console.log("成功-----", res);
                            var aa = res.data;
                            $("#ys_1").show();
                            $("#ys_1").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                            $("#ys_1").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px; "> <img src="' + aa.image_url + '"/> <span>行驶证一照片</span> </div>');
                            photo_xsz1.push(aa.image_db);
                            initLG();
                        });
                    } else if (type == "y2") {
                        ImageajaxSubmit(b64, Api.YS_Car_Manage.Upload_image, "POST", function (res) {
                            console.log("成功-----", res);
                            var aa = res.data;
                            $("#ys_2").show();
                            $("#ys_2").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                            $("#ys_2").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px;"> <img src="' + aa.image_url + '"/> <span>行驶证二照片</span> </div>');
                            photo_xsz2.push(aa.image_db);
                            initLG();
                        });
                    } else if (type == "y3") {
                        ImageajaxSubmit(b64, Api.YS_Car_Manage.Upload_image, "POST", function (res) {
                            console.log("成功-----", res);
                            var aa = res.data;
                            $("#ys_3").show();
                            $("#ys_3").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                            $("#ys_3").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px;"> <img src="' + aa.image_url + '"/> <span>驾驶证照片</span> </div>');
                            photo_jsz.push(aa.image_db);
                            initLG();
                        });
                    } else if (type == "y4") {
                        ImageajaxSubmit(b64, Api.YS_Car_Manage.Upload_image, "POST", function (res) {
                            console.log("成功-----", res);
                            var aa = res.data;
                            $("#ys_4").show();
                            $("#ys_4").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                            $("#ys_4").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px;"> <img src="' + aa.image_url + '"/> <span>身份证照片</span> </div>');
                            photo_sfz.push(aa.image_db);
                            initLG();
                        });
                    } else if (type == "y5") {
                        ImageajaxSubmit(b64, Api.YS_Car_Manage.Upload_image, "POST", function (res) {
                            console.log("成功-----", res);
                            var aa = res.data;
                            $("#ys_5").show();
                            $("#ys_5").children(".layui-elem-field").children(".layui-field-box").find(".LGallery").remove();
                            $("#ys_5").find(".TemplateParent").append('<div class="TemplateParent-Item" style="width:150px;"> <img src="' + aa.image_url + '"/> <span>保险单照片</span> </div>');
                            photo_bxd.push(aa.image_db);
                            initLG();
                        });
                    }

                };
            } else {
                // $(this).parent().next().show();
                //$(this).parent().next().children("i").html("您未上传文件，或者您上传文件类型有误！").css("color", "red");
                //$(this).parent().next().html("您未上传文件，或者您上传文件类型有误！").css("color","red");
                return false
            }
        });


        //调用高拍仪
        $(".takePhoto").on("click", function () {
            var that = $(this);
            var type = that.attr("photo-type");
            console.log(type);
            $("#camera").attr("photo-type", type);
            $("#camera").click();
        });
        //监听提交
        form.on('submit(demo1)', function (data) {
            //layer.msg(JSON.stringify(data.field));
            var json = data.field;
            var aa = {};
            aa.name = json.xsz1;
            aa.images = photo_xsz1;
            var bb = {};
            bb.name = json.xsz2;
            bb.images = photo_xsz2;
            var cc = {};
            cc.name = json.jsz;
            cc.images = photo_jsz;
            var dd = {};
            dd.name = json.sfz;
            dd.images = photo_sfz;
            var ee = {};
            ee.name = json.bxd;
            ee.images = photo_bxd;


            json.xszOne = aa;
            json.xszTwo = bb;
            json.jsz = cc;
            json.sfz = dd;
            json.bxd = ee;


            console.log(json);


            ajaxSubmit(json, Api.YS_Car_Manage.Update, "POST", function (res) {
                console.log("msg信息------", res.msg);
                // alert("添加成功");
                var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                parent.layui.table.reload('customer_unit_library', {page: {curr: 1}});
                parent.layer.msg('修改成功');
                parent.layer.close(index);
            }, "json");


            return false;
        });
        form.on('submit(back)', function (data) {
            //layer.msg(JSON.stringify(data.field));
            // alert("添加成功");
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layui.table.reload('customer_unit_library', {page: {curr: 1}});
            parent.layer.msg('返回了');
            parent.layer.close(index);


            return false;
        });
    });
</script>
</html>